<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Pinot‚Ñ¢ Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Pinot‚Ñ¢ Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZXG79NJEBY"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-ZXG79NJEBY",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Apache Pinot‚Ñ¢" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css"><title data-react-helmet="true">GapFill Function For Time-Series Datasets In Pinot | Apache Pinot‚Ñ¢</title><meta data-react-helmet="true" property="og:title" content="GapFill Function For Time-Series Datasets In Pinot | Apache Pinot‚Ñ¢"><meta data-react-helmet="true" name="description" content="Gapfilling functions in Pinot to provide the on-the-fly interpolation (filling the missing data) functionality to better handle time-series data."><meta data-react-helmet="true" property="og:description" content="Gapfilling functions in Pinot to provide the on-the-fly interpolation (filling the missing data) functionality to better handle time-series data."><meta data-react-helmet="true" property="og:url" content="https://pinot.apache.org/blog/2022/08/02/GapFill-Function-For-Time-Series-Datasets-In-Pinot"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="keywords" content="Apache Pinot,Apache Pinot 0.11.0,Interpolation,Gapfilling,Time-series,Timeseries"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pinot.apache.org/blog/2022/08/02/GapFill-Function-For-Time-Series-Datasets-In-Pinot"><link data-react-helmet="true" rel="alternate" href="https://pinot.apache.org/blog/2022/08/02/GapFill-Function-For-Time-Series-Datasets-In-Pinot" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pinot.apache.org/blog/2022/08/02/GapFill-Function-For-Time-Series-Datasets-In-Pinot" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.d071271f.css">
<link rel="preload" href="/assets/js/runtime~main.997335bd.js" as="script">
<link rel="preload" href="/assets/js/main.82c7c7e3.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/pinot-navbar-logo-722f37.svg" alt="Pinot" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/pinot-navbar-logo-722f37.svg" alt="Pinot" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.pinot.apache.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Docs</a><a class="navbar__item navbar__link" href="/download">Download</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a href="https://github.com/apache/pinot" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV" style="margin-left:2px">üåô</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV" style="margin-left:2px">‚òÄÔ∏è</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/pinot-navbar-logo-722f37.svg" alt="Pinot" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/pinot-navbar-logo-722f37.svg" alt="Pinot" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://docs.pinot.apache.org/" target="_blank" rel="noopener noreferrer" class="menu__link">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/download">Download</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/apache/pinot" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All our posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2023/09/19/Annoucing-Apache-Pinot-1-0">Announcing Apache Pinot 1.0‚Ñ¢</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2023/05/11/Geospatial-Indexing-in-Apache-Pinot">Geospatial Indexing in Apache Pinot</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2023/03/30/Apache-Pinot-0-12-Consumer-Record-Lag">Apache Pinot‚Ñ¢ 0.12 - Consumer Record Lag</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2023/02/21/Apache-Pinot-0-12-Configurable-Time-Boundary">Apache Pinot‚Ñ¢ 0.12 - Configurable Time Boundary</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2023/01/29/Apache-Pinot-Deduplication-on-Real-Time-Tables">Apache Pinot‚Ñ¢ 0.11 - Deduplication on Real-Time Tables</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/28/Apache-Pinot-Pausing-Real-Time-Ingestion">Apache Pinot‚Ñ¢ 0.11 - Pausing Real-Time Ingestion</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/22/Apache-Pinot-Timestamp-Indexes">Apache Pinot‚Ñ¢ 0.11 - Timestamp Indexes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/17/Apache Pinot-Inserts-from-SQL">Apache Pinot‚Ñ¢ 0.11 - Inserts from SQL</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/11/08/Apache Pinot-How-do-I-see-my-indexes">Apache Pinot‚Ñ¢ 0.11 - How do I see my indexes?</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/blog/2022/08/02/GapFill-Function-For-Time-Series-Datasets-In-Pinot">GapFill Function For Time-Series Datasets In Pinot</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_d4p0">GapFill Function For Time-Series Datasets In Pinot</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-02T00:00:00.000Z">August 2, 2022</time> ¬∑ 9 min read</div><div class="avatar margin-vert--md"><a href="https://www.linkedin.com/in/lakshmanan-velusamy-a778a517/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://www.datocms-assets.com/75153/1661479772-lakshmanan-portait.jpeg" alt="Weixiang Sun,Lakshmanan Velusamy"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://www.linkedin.com/in/lakshmanan-velusamy-a778a517/" target="_blank" rel="noopener noreferrer">Weixiang Sun,Lakshmanan Velusamy</a></div><small class="avatar__subtitle">Weixiang Sun,Lakshmanan Velusamy</small></div></div></header><div class="markdown"><p>Many real-world datasets are time-series in nature, tracking the value or state changes of entities over time. The values may be polled and recorded at constant time intervals or at random irregular intervals or only when the value/state changes. There are many real-world use cases of time series data. Here are some specific examples:</p><ul><li>Telemetry from sensors monitoring the status of industrial equipment.</li><li>Real-time vehicle data such as speed, braking, and acceleration, to produce the driver&#x27;s risk score trend.</li><li>Server performance metrics such as CPU, I/O, memory, and network usage over time.</li><li>An automated system tracking the status of a store or items in an online marketplace.</li></ul><p>Let us use an IOT dataset tracking the occupancy status of the individual parking slots in a parking garage using automated sensors in this post. The granularity of recorded data points might be sparse or the events could be missing due to network and other device issues in the IOT environment. The following figure demonstrates entities emitting values at irregular intervals as the value changes. Polling and recording values of all entities regularly at a lower granularity would consume more resources, take up more space on disk and during processing and incur high costs. But analytics applications that are operating on these datasets, might be querying for values at a lower granularity than the data recording interval (Ex: A dashboard showing the total no of occupied parking slots at 15 min granularity in the past week when the sensors are not recording status as frequent).</p><p><img src="https://www.datocms-assets.com/75153/1661700264-entities-emitting-data.png" alt="Entities emitting data over time at irregular intervals" title="Entities emitting data over time at irregular intervals"></p><p>It is important for Pinot to provide the on-the-fly interpolation (filling the missing data) functionality to better handle time-series data.</p><p>Starting from the 0.11.0 release, we introduced the new query syntax, gapfilling functions to interpolate data and perform powerful aggregations and data processing over time series data.</p><p>We will discuss the query syntax with an example and then the internal architecture.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="processing-time-series-data-in-pinot"></a>Processing time series data in Pinot<a class="hash-link" href="#processing-time-series-data-in-pinot" title="Direct link to heading">#</a></h2><p>Let us use the following sample data set tracking the status of parking lots in the parking space to understand this feature in detail.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="sample-dataset"></a>Sample Dataset:<a class="hash-link" href="#sample-dataset" title="Direct link to heading">#</a></h3><p><img src="https://www.datocms-assets.com/75153/1661700333-parking-data-table.png" alt="Sample parking lot dataset" title="Sample parking lot dataset"></p><p>parking_data table</p><p>Use case:¬†We want to find out the total number of parking lots that are occupied over a period of time, which would be a common use case for a company that manages parking spaces.</p><p>Let us take 30 minutes time bucket as an example:</p><p><img src="https://www.datocms-assets.com/75153/1661700377-30-min-bucket-example.png" alt="Sample parking lot dataset with 30 minute time bucket" title="Sample parking lot dataset with 30 minute time bucket"></p><p>In the 30 mins aggregation results table above, we can see a lot of missing data as many lots didn&#x27;t have anything recorded in those 30-minute windows. To calculate the number of occupied parking lots per time bucket, we need to gap-fill the missing data for each of these 30-minute windows.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="interpolating-missing-data"></a>Interpolating missing data<a class="hash-link" href="#interpolating-missing-data" title="Direct link to heading">#</a></h2><p>There are multiple ways to infer and fill the missing values. In the current version, we introduce the following methods, which are more common:</p><ul><li>FILL_PREVIOUS_VALUE¬†can be used to fill time buckets missing values for entities with the last observed value. If no previous observed value can be found, the default value is used as an alternative.</li><li>FILL_DEFAULT_VALUE¬†can be used to fill time buckets missing values for entities with the default value depending on the data type.</li></ul><p>More advanced gapfilling strategies such as using the next observed value, the value from the previous day or past week, or the value computed using a subquery shall be introduced in the future.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="gapfill-query-with-a-use-case"></a>Gapfill Query with a Use Case:<a class="hash-link" href="#gapfill-query-with-a-use-case" title="Direct link to heading">#</a></h2><p>Let us write a query to¬†<em>get</em>¬†<em>the total number of occupied parking lots every 30 minutes over time on the parking lot dataset</em>¬†discussed above.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="query-syntax"></a>Query Syntax:<a class="hash-link" href="#query-syntax" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> time_col</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">SUM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> occupied_slots_count</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> GAPFILL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">time_col</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1:MILLISECONDS:SIMPLE_DATE_FORMAT:yyyy-MM-dd HH:mm:ss.SSS&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;2021-10-01 09:00:00.000&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                   </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;2021-10-01 12:00:00.000&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;30:MINUTES&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> FILL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;FILL_PREVIOUS_VALUE&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    TIMESERIESON</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">lot_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lot_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> DATETIMECONVERT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">event_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1:MILLISECONDS:EPOCH&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1:MILLISECONDS:SIMPLE_DATE_FORMAT:yyyy-MM-dd HH:mm:ss.SSS&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;30:MINUTES&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> time_col</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               lot_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lastWithTime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">is_occupied</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> event_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;INT&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> parking_data</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> event_time </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">1633078800000</span><span class="token plain"> </span><span class="token operator">AND</span><span class="token plain">  event_time </span><span class="token operator">&lt;=</span><span class="token plain"> </span><span class="token number">1633089600000</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number">100</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This query suggests three main steps:</p><ol><li>The raw data will be aggregated;</li><li>The aggregated data will be gapfilled;</li><li>The gapfilled data will be aggregated.</li></ol><p>We make one assumption that the raw data is sorted by timestamp. The Gapfill and Post-Gapfill Aggregation will not sort the data.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="query-components"></a>Query components:<a class="hash-link" href="#query-components" title="Direct link to heading">#</a></h3><p>The following concepts were added to interpolate and handle time-series data.</p><ul><li>LastWithTime(dataColumn, timeColumn, &#x27;dataType&#x27;)¬†- To get the last value of¬†dataColumn¬†where the¬†timeColumn¬†is used to define the time of dataColumn. This is useful to pick the latest value when there are multiple values found within a time bucket. Please see¬†<a href="https://docs.pinot.apache.org/users/user-guide-query/supported-aggregations" target="_blank" rel="noopener noreferrer">https://docs.pinot.apache.org/users/user-guide-query/supported-aggregations</a>¬†for more details.</li><li>Fill(colum, FILL_TYPE)¬†- To fill the missing data of the column with the FILL_TYPE.</li><li>TimeSeriesOn¬†- To specify the columns to uniquely identify entities whose data will be interpolated.</li><li>Gapfill¬†- Specify the time range, the time bucket size, how to fill the missing data, and entity definition.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="query-workflow"></a>Query Workflow<a class="hash-link" href="#query-workflow" title="Direct link to heading">#</a></h3><p>The innermost sql will convert the raw event table to the following table.</p><p><img src="https://www.datocms-assets.com/75153/1661700439-innermost-sql.png" alt="Sample parking lot query workflow innermost SQL" title="Sample parking lot query workflow innermost SQL"></p><p>The second most nested sql will gap fill the returned data as below:</p><p><img src="https://www.datocms-assets.com/75153/1661700473-second-most.png" alt="Sample parking lot query workflow second most SQL" title="Sample parking lot query workflow second most SQL"></p><p>The outermost query will aggregate the gapfilled data as follows:</p><p><img src="https://www.datocms-assets.com/75153/1661700517-outermost.png" alt="Sample parking lot query workflow outermost SQL" title="Sample parking lot query workflow outermost SQL"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="other-supported-query-scenarios"></a>Other Supported Query Scenarios:<a class="hash-link" href="#other-supported-query-scenarios" title="Direct link to heading">#</a></h3><p>The above example demonstrates the support to aggregate before and post gapfilling. Pre and/or post aggregations can be skipped if they are not needed. The gapfilling query syntax is flexible to support the following use cases:</p><ul><li>Select/Gapfill¬†- Gapfill the missing data for the time bucket. Just the raw events are fetched, gapfilled, and returned. No aggregation is needed.</li><li>Aggregate/Gapfill¬†- If there are multiple entries within the time bucket we can pick a representative value by applying an aggregate function. Then the missing data for the time buckets will be gap filled.</li><li>Gapfill/Aggregate¬†- Gapfill the data and perform some form of aggregation on the interpolated data.</li></ul><p>For detailed query syntax and how it works, please refer to the documentation here:¬†<a href="https://docs.pinot.apache.org/users/user-guide-query/gap-fill-functions" target="_blank" rel="noopener noreferrer">https://docs.pinot.apache.org/users/user-guide-query/gap-fill-functions</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="how-does-it-work"></a>How does it work?<a class="hash-link" href="#how-does-it-work" title="Direct link to heading">#</a></h2><p>Let us use the sample query given above as an example to understand what&#x27;s going on behind the scenes and how Pinot executes the gapfill queries.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="request-flow"></a>Request Flow<a class="hash-link" href="#request-flow" title="Direct link to heading">#</a></h3><p>Here is the list of steps in executing the query at a high level:</p><ol><li>Pinot Broker receives the gapfill query. It will strip off the gapfill part and send out the stripped SQL query to the pinot server.</li><li>The pinot server will process the query as a normal query and return the result back to the pinot broker.</li><li>The pinot broker will run the DataTableReducer to merge the results from pinot servers. The result will be sent to GapfillProcessor.</li><li>The GapfillProcessor will gapfill the received result and apply the filter against the gap-filled result.</li><li>Post-Gapfill aggregation and filtering will be applied to the result from the last step.</li></ol><p>There are two gapfill-specific steps:</p><ol><li>When Pinot Broker Server receives the gapfill SQL query, it will strip out gapfill related information and send out the stripped SQL query to the pinot server</li><li>GapfillProcessor will process the result from BrokerReducerService. The gapfill logic will be applied to the reduced result.</li></ol><p><img src="https://www.datocms-assets.com/75153/1661700601-gapfill-steps.png" alt="Gapfill steps" title="Gapfill steps"></p><p>Here is the stripped version of the sql query sent to servers for the query shared above:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> DATETIMECONVERT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">event_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1:MILLISECONDS:EPOCH&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1:MILLISECONDS:SIMPLE_DATE_FORMAT:yyyy-MM-dd HH:mm:ss.SSS&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;30:MINUTES&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> time_col</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               lot_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lastWithTime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">is_occupied</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> event_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;INT&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">status</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> parking_data</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> event_time </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">1633078800000</span><span class="token plain"> </span><span class="token operator">AND</span><span class="token plain">  event_time </span><span class="token operator">&lt;=</span><span class="token plain"> </span><span class="token number">1633089600000</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number">100</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="execution-plan"></a>Execution Plan<a class="hash-link" href="#execution-plan" title="Direct link to heading">#</a></h3><p>The sample execution plan for this query is as shown in the figure below:</p><p><img src="https://www.datocms-assets.com/75153/1661700642-execution-plan.png" alt="Sample query execution plan" title="Sample query execution plan"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="time-and-space-complexity"></a>Time and Space complexity:<a class="hash-link" href="#time-and-space-complexity" title="Direct link to heading">#</a></h3><p>Let us say there are M entities, R rows returned from servers, and N time buckets. The data is gapfilled time bucket by time bucket to limit the broker memory usage to O(M + N + R). When the data is gapfilled for a time bucket, it will be aggregated and stored in the final result (which has N slots). The previous values for each of the M entities are maintained in memory and carried forward as the gapfilling is performed in sequence. The time complexity is O(M * N) where M is the number of entities and N is the number of time buckets.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="challenges"></a>Challenges<a class="hash-link" href="#challenges" title="Direct link to heading">#</a></h3><p><img src="https://www.datocms-assets.com/75153/1661700716-challenges.png" alt="Sample server challenges graph" title="Sample server challenges graph"></p><p>As the time-series datasets are enormous and partitioned, it&#x27;s hard to get answers to the following questions:</p><ul><li>How many different entities exist within the query time frame. In the temporal partition scheme demonstrated above, a server/partition may not know the answer.</li><li>What&#x27;s the previously observed value for entities especially for the first data points in a time bucket where previous time buckets don‚Äôt exist in the same server.</li></ul><p>For the scenario shown in the figure above, server2 may not know about the circle entity, as there are no events for the circle in Server2. It would also not know the last observed value for the square entity frame beginning of the time bucket till the first observed value timestamp within the partition.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="the-future-work"></a>The Future Work<a class="hash-link" href="#the-future-work" title="Direct link to heading">#</a></h2><p>When doing the gapfill for one or a few entities, there might not be too much data. But when we deal with a large dataset that has multiple entities queried over a long date range without any filtering, this gets tricky. Since gapfill happens at the pinot broker, it will become very slow and the broker will become a bottleneck. The raw data transferred from servers to brokers would be enormous. Data explodes when interpolated. Parallelism is limited as the single broker instance is handling the query.</p><p>The next step of the gapfill project is to remove the pinot broker as a bottleneck. The gapfill logic will be pushed down to the servers and be running where the data live. This will reduce the data transmission and increase the parallelism and performance of gapfill.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/pinot">Pinot</a><a class="margin-horiz--sm" href="/blog/tags/data">Data</a><a class="margin-horiz--sm" href="/blog/tags/analytics">Analytics</a><a class="margin-horiz--sm" href="/blog/tags/user-facing-analytics">User-Facing Analytics</a><a class="margin-horiz--sm" href="/blog/tags/interpolation">interpolation</a><a class="margin-horiz--sm" href="/blog/tags/gapfilling">gapfilling</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/pinot-site/edit/dev/website/blog/2022-08-02-GapFill-Function-For-Time-Series-Datasets-In-Pinot.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2022/11/08/Apache Pinot-How-do-I-see-my-indexes"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ Apache Pinot‚Ñ¢ 0.11 - How do I see my indexes?</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/04/04/Announcing-Apache-Pinot-0-10"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Announcing Apache Pinot 0.10 ¬ª</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#processing-time-series-data-in-pinot" class="table-of-contents__link">Processing time series data in Pinot</a><ul><li><a href="#sample-dataset" class="table-of-contents__link">Sample Dataset:</a></li></ul></li><li><a href="#interpolating-missing-data" class="table-of-contents__link">Interpolating missing data</a></li><li><a href="#gapfill-query-with-a-use-case" class="table-of-contents__link">Gapfill Query with a Use Case:</a><ul><li><a href="#query-syntax" class="table-of-contents__link">Query Syntax:</a></li><li><a href="#query-components" class="table-of-contents__link">Query components:</a></li><li><a href="#query-workflow" class="table-of-contents__link">Query Workflow</a></li><li><a href="#other-supported-query-scenarios" class="table-of-contents__link">Other Supported Query Scenarios:</a></li></ul></li><li><a href="#how-does-it-work" class="table-of-contents__link">How does it work?</a><ul><li><a href="#request-flow" class="table-of-contents__link">Request Flow</a></li><li><a href="#execution-plan" class="table-of-contents__link">Execution Plan</a></li><li><a href="#time-and-space-complexity" class="table-of-contents__link">Time and Space complexity:</a></li><li><a href="#challenges" class="table-of-contents__link">Challenges</a></li></ul></li><li><a href="#the-future-work" class="table-of-contents__link">The Future Work</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a href="https://docs.pinot.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">What is Apache Pinot?</a></li><li class="footer__item"><a class="footer__link-item" href="/who_uses">Who uses Apache Pinot?</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/pinot-components" target="_blank" rel="noopener noreferrer" class="footer__link-item">Components</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/basics/architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">Architecture</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/plugins/plugin-architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">Plugins Architecture</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Integrations</h4><ul class="footer__items"><li class="footer__item"><a href="https://docs.pinot.apache.org/integrations/trino" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trino</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/integrations/presto" target="_blank" rel="noopener noreferrer" class="footer__link-item">Presto</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/integrations/superset" target="_blank" rel="noopener noreferrer" class="footer__link-item">Superset</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/integrations/thirdeye" target="_blank" rel="noopener noreferrer" class="footer__link-item">ThirdEye</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a href="https://docs.pinot.apache.org/getting-started" target="_blank" rel="noopener noreferrer" class="footer__link-item">Getting Started</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/pinot-components" target="_blank" rel="noopener noreferrer" class="footer__link-item">Pinot Components</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/users" target="_blank" rel="noopener noreferrer" class="footer__link-item">User Guide</a></li><li class="footer__item"><a href="https://docs.pinot.apache.org/operators/operating-pinot" target="_blank" rel="noopener noreferrer" class="footer__link-item">Administration</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/apache-pinot/shared_invite/zt-5z7pav2f-yYtjZdVA~EDmrGkho87Vzw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://github.com/apache/pinot" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li><li class="footer__item"><a href="https://twitter.com/ApachePinot" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="mailto:dev-subscribe@pinot.apache.org?Subject=SubscribeToPinot" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Apache</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li><li class="footer__item"><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://pinot.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_94kH"><img src="/img/logo.svg" alt="Apache Pinot‚Ñ¢" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/logo.svg" alt="Apache Pinot‚Ñ¢" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footerCopyright_-piB">Copyright ¬© 2023 The Apache Software Foundation.<br>Apache Pinot, Pinot, Apache, the Apache feather logo, and the Apache Pinot project logo are registered trademarks of The Apache Software Foundation.<br><br>This page has references to third party software - Presto, PrestoDB, ThirdEye, Trino, TrinoDB, that are not part of the Apache Software Foundation and are not covered under the Apache License.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.997335bd.js"></script>
<script src="/assets/js/main.82c7c7e3.js"></script>
</body>
</html>